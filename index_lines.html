<!DOCTYPE html>
<meta charset="utf-8">
<title> Global Warming Data </title>
 

<head>

<!-- Bootstrap theme stuff -->
<!-- Latest compiled and minified CSS -->
<!--link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"-->
<!-- Optional theme -->
<!--link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css"-->

<style type="text/css">

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    shape-rendering: crispEdges;
}

.line {
    fill: none;
    stroke: steelblue;
    opacity: 0.7;
    stroke-width: 2.5px;
}

body {
    margin-left: 35px;
}

.btn {
    width:80px;
    height:25px;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}
</style>
</head>
<body>

<h2> CO2 Emission across Countries from 1960 to 2008  </h2>

Y Variable:
<select id="y-variable">
  <option value="Tech">Intensity (Carbon / GDP)</option>
  <option value="Year">Year</option>
  <option value="Population">Population</option>
  <option value="GDP">GDP per capita</option>
  <option value="CO2">Carbon emissions</option>
</select>
Y on log scale? <input id="y-log-scale" type="checkbox" value="log-scale">

 <br/>

X Variable:
<select id="x-variable">
  <option value="Year">Year</option>
  <option value="Population">Population</option>
  <option value="GDP">GDP per capita</option>
  <option value="CO2">Carbon emissions</option>
  <option value="Tech">Intensity (Carbon / GDP)</option>
</select>
X on log scale? <input id="x-log-scale" type="checkbox" value="log-scale">

<br/>


<button class="btn btn-default" type="button" id="swap-axes">Swap axes</button>
<button class="btn btn-default" type="button" id="reset">Reset</button>

 <br/>

Region:
<select id="region">
  <option value="All">Entire World</option>
  <option value=" Southeast Asia">Southeast Asia</option>
  <option value=" Eastern Europe">Eastern Europe</option>
  <option value=" Africa">Africa</option>
  <option value=" Western Europe">Western Europe</option>
  <option value=" Latin America">Latin America</option>
  <option value=" Former Soviet Union">Former Soviet Union</option>
  <option value=" Australia_NZ">Australia and NZ</option>
  <option value=" Middle East">Middle East</option>
  <option value=" China">China</option>
  <option value=" Canada">Canada</option>
  <option value=" India">India</option>
  <option value=" Japan">Japan</option>
  <option value=" USA">USA</option>
  <option value=" Korea">Korea</option>
</select>


 <br/>
 <br/>
 <div id="container1" style="position: relative; width: 80%; max-height: 450px;"></div>

 
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script type="text/javascript"></script>
 

<script>    

/*
TODO: Carbon emissions are by person. Change it!!
*/


/*
A lot of code is taken from "Interactive Data Visualization for the Web"
by Scott Murray.
Also http://bost.ocks.org/mike/nations/ and
http://bl.ocks.org/mbostock/3883245
 */

var w = 700;
var h = 500;
var padding_h = 40;
var padding_left = 70;
var padding_right = 150;
var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

// From https://stackoverflow.com/questions/14167863/how-can-i-bring-a-circle-to-the-front-with-d3
d3.selection.prototype.moveToFront = function() {
  return this.each(function(){
    this.parentNode.appendChild(this);
  });
};

// todo: when initially plotting, get the selections from the drop-down. or force the drop-down to agree.

// TODO: if any missing observations, then nothing will show up. (see former ussr gdp and intensity data)

var make_scatter = function(dataset_object) {
    var dataset = Object.keys(dataset_object).map(function (key) {
        return dataset_object[key]
    });

    var xScale = d3.scale.linear()
      .domain([0, 1.04*d3.max(dataset, function(d) { return d.GDP; })])
      .range([padding_left, w - padding_right]);
    var yScale = d3.scale.linear()
      .domain([0, 1.04*d3.max(dataset, function(d) { return d.Tech; })])
      .range([h - padding_h, padding_h/2]);
    var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom");
    var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient("left");


    svg.selectAll("circle")
       .data(dataset)
       .enter()
       .append("circle")
       .attr({
           cx: function(d) {
               return xScale(d.GDP);
           },
           cy: function(d) {
               return yScale(d.Tech);
           },
           r: 4,
           fill: "steelblue"
       })
       .on("mouseover", function(d) {
           var xPosition = parseFloat(d3.select(this).attr("cx"));
           var yPosition = parseFloat(d3.select(this).attr("cy")) - 10;

           d3.select(this)
             .attr("fill", "orange");

           svg.append("text")
              .attr("id", "tooltip")
              .attr("x", xPosition)
              .attr("y", yPosition)
              .attr("text-anchor", "middle")
              .attr("font-family", "sans-serif")
              .attr("font-size", "11px")
              .attr("font-weight", "bold")
              .attr("fill", "black")
              .text("Country: " + d.Iso + 
                    ", Year: " + d.Year);
       })
       .on("mouseout", function() {
           d3.select(this)
             .attr("fill", "steelblue");

           d3.select("#tooltip").remove();
       });

    svg.append("g")
       .attr("class", "axis")
       .attr("transform", "translate(0," + (h - padding_h) + ")")
       .call(xAxis);
    svg.append("g")
       .attr("class", "axis")
       .attr("transform", "translate(" + padding_left + ",0)")
       .call(yAxis);

};


//var make_lines = function(dataset, varx, vary) {
var make_lines = function(varx, vary) {
    if (region_selected === "All") {
        dataset = countryArray;
    } else {
        dataset = regionArray[region_selected];
    }

    var year_format = d3.format("d");
    var xdomain = [];
    var ydomain = [];

    if (varx === "Year") {
        xdomain = [1960, 2010];
    } else {
        if (logx) {
            xdomain =  [d3.min(dataset,function(d) {
                       var min_tmp = d[0][varx];
                       for (var i = 0; i < d.length; i++) {
                           min_tmp = d3.min([min_tmp, d[i][varx]]);
                       }
                       return min_tmp;
                   }),
                   d3.max(dataset, function(d) {
                           var max_tmp = 0;
                           for (var i = 0; i < d.length; i++) {
                               max_tmp = d3.max([max_tmp, d[i][varx]]);
                           }
                           return max_tmp;
                       })];
        } else {
            xdomain = [0, 1.04*d3.max(dataset, function(d) {
                           var max_tmp = 0;
                           for (var i = 0; i < d.length; i++) {
                               max_tmp = d3.max([max_tmp, d[i][varx]]);
                           }
                           return max_tmp;
                       })];
        }
    }
    if (vary === "Year") {
        ydomain = [1960, 2010];
    } else {
        if (logy) {
            ydomain = [d3.min(dataset,function(d) {
                       var min_tmp = d[0][vary];
                       for (var i = 0; i < d.length; i++) {
                           min_tmp = d3.min([min_tmp, d[i][vary]]);
                       }
                       return min_tmp;
                   }),
                   d3.max(dataset, function(d) {
                       var max_tmp = 0;
                       for (var i = 0; i < d.length; i++) {
                           max_tmp = d3.max([max_tmp, d[i][vary]]);
                       }
                       return max_tmp;
                   })];
        } else {
            ydomain = [0, 1.04*d3.max(dataset, function(d) {
                       var max_tmp = 0;
                       for (var i = 0; i < d.length; i++) {
                           max_tmp = d3.max([max_tmp, d[i][vary]]);
                       }
                       return max_tmp;
                   })];
        }
    }
 

    // todo: allow for log scale
    if (logx) {
        var x = d3.scale.log()
                  .domain(xdomain)
                  .range([padding_left, w - padding_right]);
    } else {
        var x = d3.scale.linear()
                  .domain(xdomain)
                  .range([padding_left, w - padding_right]);
    }

// TODO: fix up log scale. make optional, make the range based on the data, put in axis labels
    if (logy) {
        var y = d3.scale.log()
                  .domain(ydomain)
                  .range([h - padding_h, padding_h/2]);
    } else {
        var y = d3.scale.linear()
                  .domain(ydomain)
                  .range([h - padding_h, padding_h/2]);
    }

    // TODO: allow the variable to be selected
    var line = d3.svg.line()
        .defined(function(d) { return (!isNaN(d[vary])) && (!isNaN(d[varx])); })
        .x(function(d) { return x(d[varx]); })
        .y(function(d) { return y(d[vary]); });


    if (logx) {
        var xScale = d3.scale.log()
          .domain(xdomain)
          .range([padding_left, w - padding_right]);
    } else {
        var xScale = d3.scale.linear()
          .domain(xdomain)
          .range([padding_left, w - padding_right]);
    }
    if (logy) {
        var yScale = d3.scale.log()
          .domain(ydomain)
          .range([h - padding_h, padding_h/2]);
    } else {
        var yScale = d3.scale.linear()
          .domain(ydomain)
          .range([h - padding_h, padding_h/2]);
    }

    if (varx === "Year") {
        var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .tickFormat(d3.format("d"));
    } else {
        var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom");
    }
    if (vary === "Year") {
        var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left")
                    .tickFormat(d3.format("d"));
    } else {
        var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left");
    }

    // Clean up before adding new axes:
    svg.selectAll("g")
       .remove();
    svg.selectAll("text").attr("class", "x label").remove();
    svg.selectAll("text").attr("class", "y label").remove();
    svg.append("g")
       .attr("class", "axis")
       .attr("transform", "translate(0," + (h - padding_h) + ")")
       .call(xAxis);
    svg.append("g")
       .attr("class", "axis")
       .attr("transform", "translate(" + padding_left + ",0)")
       .call(yAxis);

   var vartonames = function(varname) {
        if (varname === "GDP") {
            return "GDP per capita (USD)"
        } else if (varname === "Tech") {
            return "Carbon Intensity (tonnes carbon / $10,000)"
        } else if (varname === "Population") {
            return "Population (1,000s)"
        } else if (varname === "CO2") {
            return "Carbon Emissions per capita" // TODO: change!!!
        } else {
            return varname
        }
   };

//TODO: fix the removal
    if (varx === "Year") {
        for (var i = 0; i < dataset.length; i++) {
            var xPosition = x(2010.5);
            var yPosition = y(dataset[i][dataset[i].length-1][vary]) + 3;
            if (isNaN(yPosition)) {
                // Use 2008 data
                yPosition = y(dataset[i][dataset[i].length-3][vary]) + 3;
            }
            svg.append("text")
               .attr("id", "tooltip")
               .attr("x", xPosition)
               .attr("y", yPosition)
               .attr("text-anchor", "start")
               .attr("opacity", 0.55)
               .attr("font-family", "sans-serif")
               .attr("font-size", "11px")
               .attr("font-weight", "bold")
               .attr("fill", "black")
               .text(dataset[i][0].Country);
        }
    }

// add x-axis label:
    svg.append("text")
       .attr("class", "x title")
       .attr("text-anchor", "middle")
       .attr("x", w/2)
       .attr("y", h)
       .text(vartonames(varx));
// add y-axis label:
    svg.append("text")
       .attr("class", "y label")
       .attr("text-anchor", "middle")
       .attr("y", 5)
       .attr("x", -h/2 + padding_h)
       .attr("dy", ".5em")
       .attr("transform", "rotate(-90)")
       .text(vartonames(vary));

    svg.selectAll(".line")
       .remove();
    svg.selectAll(".line")
       .data(dataset)
       .enter()
       .append("path")
       .attr("class", "line")
       .attr("d", line)
      // fixing below still
       .on("mouseover", function(d) {
           console.log("moused over");
           // todo: change position of tooltip type thing
           var xPosition = w/2;
           var yPosition = 20;

           d3.select(this)
             .moveToFront()
             .style("opacity", "1")
             .style("stroke", "orange");

           svg.append("text")
              .attr("id", "tooltip-hover")
              .attr("x", xPosition)
              .attr("y", yPosition)
              .attr("text-anchor", "middle")
              .attr("font-family", "sans-serif")
              .attr("font-size", "12px")
              .attr("font-weight", "bold")
              .attr("fill", "orange")
              .text("Country: " + d[0].Country);
       })
       .on("mouseout", function() {
           console.log("mouseout detected");
           d3.select(this)
             .style("opacity", "0.7")
             .style("stroke", "steelblue");

           d3.select("#tooltip-hover").remove();
       });
       // TODO: implement clicking behavior
       /*
       .on("click", function(d) {
           
           console.log("clicked");
           console.log(d3.select(this));
           d3.select(this)
             .moveToFront()
             .style("stroke", "black");
       });
       */

};





// TODO: stop mutating the [[Prototype]] of an object??


var countryData = {
    USA: []
};
var regionsMap = {
};
var regionArray = {
};

var load_data = function(Isocode) {
    d3.csv("gcam_region_mapping.csv", function(error, data) {
        data.forEach(function(d) {
            if (!(d.Region in regionsMap)) {
                regionsMap[d.Region] = [d.Isocode];
            } else {
                regionsMap[d.Region].push(d.Isocode);
            }
        });
    });
    console.log(regionsMap)
    d3.csv("data_co2.csv", function(error, data) {
          data
            .forEach(function(d) {
                // create data for map
                fullData[d.Year][d.Isocode] = {
                  Iso: d.Isocode,
                 // fillKey: get_fill(+d.Tech),
                  Year: +d.Year,
                  Tech: +d.Tech,
                  GDP: +d.GDP,
                  Pop: +d.PopTotal
                };

                if (!(d.Isocode in countryData)) {
                    countryData[d.Isocode] = []
                }
                countryData[d.Isocode].push({
                  Iso: d.Isocode,
                  Country: d.Country,
                  Year: +d.Year,
                  Tech: +d.Tech,
                  GDP: +d.GDP,
                  Population: +d.PopTotal,
                  CO2: +d.CO2
                });
              });
        //make_scatter(fullData[Year]);
        for (var region in regionsMap) {
            regionArray[region] = [];
        }
        function include(arr,obj) {
            return (arr.indexOf(obj) != -1);
        }
        countryArray = [];
        for (iso in countryData) {
            for (var region in regionsMap) {
// Inefficient way of making this object right now
                if (include(regionsMap[region], iso)) {
                    regionArray[region].push(countryData[iso]);
                }
            }

            countryArray.push(countryData[iso]);
        }
        //make_lines(countryArray, varx, vary)
        make_lines(varx, vary)
    });   
};

var varx = d3.select("#x-variable")
             .property("value");
var vary = d3.select("#y-variable")
             .property("value");
var logx = d3.select("#x-log-scale")
             .property("checked");
var logy = d3.select("#y-log-scale")
             .property("checked");
var region_selected = d3.select("#region")
                        .property("value"); 
 
//load_data(1995);
load_data("USA");

d3.select("#x-variable")
  .on("change", function() {
        varx = d3.select(this).property("value");
        //make_lines(countryArray, varx, vary);
        make_lines(varx, vary);
      });
d3.select("#y-variable")
  .on("change", function() {
        vary = d3.select(this).property("value");
        //make_lines(countryArray, varx, vary);
        make_lines(varx, vary);
      });

// TODO: create multiple buttons for log scale which are mutually exclusive, or something
d3.select("#x-log-scale")
  .on("change", function() {
        console.log("logx change detected");
        logx = d3.select(this).property("checked");
        //make_lines(countryArray, varx, vary);
        make_lines(varx, vary);
      });
d3.select("#y-log-scale")
  .on("change", function() {
        console.log("logy change detected");
        logy = d3.select(this).property("checked");
        //make_lines(countryArray, varx, vary);
        make_lines(varx, vary);
      });
d3.select("#region")
  .on("change", function() {
        console.log("region change detected");
        region_selected = d3.select(this).property("value");
        make_lines(varx, vary);
      });


//<button type="button" id="swap-axes">Swap axes</button>
d3.select("#swap-axes")
  .on("click", function() {
          console.log("Swap axes button clicked");
          var var_tmp = varx;
          varx = vary;
          vary = var_tmp;
          var log_tmp = logx;
          logx = logy;
          logy = log_tmp;
          // swap variables in drop-down menus
          xvar_tmp = document.getElementById("x-variable").value;
          document.getElementById("x-variable").value =
              document.getElementById("y-variable").value;
          document.getElementById("y-variable").value = xvar_tmp;
          // swap checks for x and y log scale checkboxes
          xlogscale_tmp = document.getElementById("x-log-scale").checked;
          document.getElementById("x-log-scale").checked =
              document.getElementById("y-log-scale").checked;
          document.getElementById("y-log-scale").checked = xlogscale_tmp;
          //make_lines(countryArray, varx, vary);
          make_lines(varx, vary);
      });

//<button class="btn btn-default" type="button" id="reset">Reset</button>
d3.select("#reset")
  .on("click", function() {
          console.log("Reset button clicked");
          varx = "Year";
          vary = "Tech";
          logx = false;
          logy = false;
          region_selected = "All";
          document.getElementById("x-variable").value = "Year";
          document.getElementById("region").value = "All";
          document.getElementById("y-variable").value = "Tech";
          document.getElementById("x-log-scale").checked = false;
          document.getElementById("y-log-scale").checked = false;
          make_lines(varx, vary);
      });



var fullData = {
    1960: {},
    1961: {},
    1962: {},
    1963: {},
    1964: {},
    1965: {},
    1966: {},
    1967: {},
    1968: {},
    1969: {},
    1970: {},
    1971: {},
    1972: {},
    1973: {},
    1974: {},
    1975: {},
    1976: {},
    1977: {},
    1978: {},
    1979: {},
    1980: {},
    1981: {},
    1982: {},
    1983: {},
    1984: {},
    1985: {},
    1986: {},
    1987: {},
    1988: {},
    1989: {},
    1990: {},
    1991: {},
    1992: {},
    1993: {},
    1994: {},
    1995: {},
    1996: {},
    1997: {},
    1998: {},
    1999: {},
    2000: {},
    2001: {},
    2002: {},
    2003: {},
    2004: {},
    2005: {},
    2006: {},
    2007: {},
    2008: {},
    2009: {},
    2010: {}
};





</script>

</body>
